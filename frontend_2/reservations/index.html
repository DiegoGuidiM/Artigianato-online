<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Le tue prenotazioni</title>
  <link rel="stylesheet" href="../rooms/style.css">
  <style>
    /* Small, unobtrusive extras that reuse your classes */
    .status-chip { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:600; }
    .status-confirmed { background:#e6f6ec; color:#0b7a36; }
    .status-cancelled { background:#fde8e8; color:#b42318; }
    .status-pending   { background:#fff5e6; color:#9a6a00; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; }
    .btn { appearance:none; border:1px solid #ddd; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .btn-confirm { background:#0bb36c; color:white; border-color:transparent; }
    .btn-cancel  { background:#ef4444; color:white; border-color:transparent; }
    .skeleton { background:linear-gradient(90deg,#f2f2f2,#e9e9e9,#f2f2f2); background-size:200% 100%; animation:sk 1.2s infinite; }
    @keyframes sk { 0%{background-position:200% 0} 100%{background-position:-200% 0} }
    .room-photo__img { width:100%; height:100%; object-fit:cover; border-radius:12px; }
    .empty { text-align:center; color:#777; padding:40px 0; }
    .error-banner { background:#fde8e8; color:#b42318; padding:10px 12px; border-radius:10px; margin:8px 0; }
  </style>
</head>
<body>
  <main class="page">
    <a class="back-map" href="../map/index.html" aria-label="Torna alla mappa">‚Üê Back</a>
    <h1 class="title">Le tue prenotazioni</h1>
    <div class="title-underline" aria-hidden="true"></div>

    <!-- Error banner (hidden by default) -->
    <div id="error" class="error-banner" role="alert" style="display:none;"></div>

    <section id="grid" class="grid" style="grid-template-columns:1fr; gap:16px;">
      <!-- Skeleton placeholder items while loading -->
      <article class="room-card">
        <div class="room-photo skeleton" style="display:flex;align-items:center;justify-content:center;">
          <div class="room-photo__ph">üìÖ</div>
        </div>
        <div class="room-info">
          <h2 class="skeleton" style="height:20px;width:60%;border-radius:8px;"></h2>
          <div class="room-meta" style="margin-top:8px;">
            <div class="skeleton" style="height:14px;width:40%;border-radius:8px;"></div>
          </div>
          <div class="room-desc skeleton" style="height:36px;border-radius:8px;margin-top:8px;"></div>
        </div>
      </article>
      <article class="room-card">
        <div class="room-photo skeleton" style="display:flex;align-items:center;justify-content:center;">
          <div class="room-photo__ph">üìÖ</div>
        </div>
        <div class="room-info">
          <h2 class="skeleton" style="height:20px;width:55%;border-radius:8px;"></h2>
          <div class="room-meta" style="margin-top:8px;">
            <div class="skeleton" style="height:14px;width:35%;border-radius:8px;"></div>
          </div>
          <div class="room-desc skeleton" style="height:36px;border-radius:8px;margin-top:8px;"></div>
        </div>
      </article>
    </section>
  </main>

  <script src="../common/config.js"></script>
  <script src="../common/auth.js"></script>
  <script>
   
   // --- Page protection (already present) ---
   
    Auth?.requireAuth("../login/index.html");
    // --- Small helper: pick API base from your config, with safe fallbacks ---
    const API_BASE = (window.CONFIG && (CONFIG.API_BASE_URL || CONFIG.API_URL || CONFIG.API)) || "";
    const BOOKINGS_API = API_BASE + "/api/bookings";

    // --- Utilities: formatting date/time safely from ISO/time strings ---
    function formatDate(isoDate) {
      try {
        // Expecting 'YYYY-MM-DD' from the backend for availability_date
        const [y,m,d] = String(isoDate||"").split("-");
        const dt = new Date(Number(y), Number(m)-1, Number(d));
        return dt.toLocaleDateString("it-IT", { day:"2-digit", month:"short", year:"numeric" });
      } catch { return isoDate; }
    }
    function formatTime(t) {
      // t like '14:00:00' -> '14:00'
      return (t || "").slice(0,5);
    }

    // --- Map booking status to css badge classes ---
    function statusClass(status) {
      if (!status) return "status-chip status-pending";
      const s = status.toLowerCase();
      if (s.includes("confermat")) return "status-chip status-confirmed";
      if (s.includes("annullat")) return "status-chip status-cancelled";
      return "status-chip status-pending";
    }

    // --- Render a single booking card ---
    function renderBookingCard(b) {
      const article = document.createElement("article");
      article.className = "room-card";

      const photo = document.createElement("div");
      photo.className = "room-photo";

      // Prefer backend-provided image (space_image), fallback to emoji placeholder
      if (b.space_image) {
        const img = document.createElement("img");
        img.src = b.space_image;
        img.alt = b.space_name || "Space";
        img.className = "room-photo__img";
        photo.appendChild(img);
      } else {
        const ph = document.createElement("div");
        ph.className = "room-photo__ph";
        ph.textContent = "üìÖ";
        photo.appendChild(ph);
      }

      const info = document.createElement("div");
      info.className = "room-info";

      const h2 = document.createElement("h2");
      h2.textContent = b.space_name || "Spazio prenotato";

      const meta = document.createElement("div");
      meta.className = "room-meta";
      const metaLeft = document.createElement("div");
      metaLeft.innerHTML = `
        <span class="${statusClass(b.booking_status)}" aria-label="Stato prenotazione">
          ${b.booking_status || "In attesa"}
        </span>
      `;
      const metaRight = document.createElement("div");
      metaRight.textContent = `${b.location_name || ""} ${b.city ? " ¬∑ " + b.city : ""}`;

      meta.appendChild(metaLeft);
      meta.appendChild(metaRight);

      const desc = document.createElement("div");
      desc.className = "room-desc";
      const dateStr = formatDate(b.availability_date);
      const timeStr = `${formatTime(b.start_time)}‚Äì${formatTime(b.end_time)}`;
      desc.textContent = `${dateStr} ¬∑ ${timeStr}`;

      // Actions (Confirm / Cancel)
      const actions = document.createElement("div");
      actions.className = "actions";
      actions.setAttribute("aria-label", "Azioni prenotazione");

      // Confirm button (show only if not confirmed/cancelled)
      const isConfirmed = (b.booking_status || "").toLowerCase().includes("confermat");
      const isCancelled = (b.booking_status || "").toLowerCase().includes("annullat");

      if (!isConfirmed && !isCancelled) {
        const btnConfirm = document.createElement("button");
        btnConfirm.className = "btn btn-confirm";
        btnConfirm.textContent = "Conferma";
        btnConfirm.addEventListener("click", async () => {
          btnConfirm.disabled = true;
          try {
            const res = await fetch(`${BOOKINGS_API}/${b.id_booking}/confirm`, { method: "POST", credentials: "include" });
            if (!res.ok) throw new Error("Confirm failed");
            // Optimistically update UI
            b.booking_status = "Confermata";
            refreshCard(article, b);
          } catch (e) {
            showError("Errore durante la conferma della prenotazione.");
            btnConfirm.disabled = false;
          }
        });
        actions.appendChild(btnConfirm);
      }

      // Cancel button (always show unless already cancelled)
      if (!isCancelled) {
        const btnCancel = document.createElement("button");
        btnCancel.className = "btn btn-cancel";
        btnCancel.textContent = "Annulla";
        btnCancel.addEventListener("click", async () => {
          // Confirm UI prompt to avoid accidental cancellation
          if (!confirm("Sei sicuro di voler annullare questa prenotazione?")) return;
          btnCancel.disabled = true;
          try {
            const res = await fetch(`${BOOKINGS_API}/${b.id_booking}/cancel`, { method: "POST", credentials: "include" });
            if (!res.ok) throw new Error("Cancel failed");
            // Optimistically update UI
            b.booking_status = "Annullata";
            refreshCard(article, b);
          } catch (e) {
            showError("Errore durante l'annullamento della prenotazione.");
            btnCancel.disabled = false;
          }
        });
        actions.appendChild(btnCancel);
      }

      info.appendChild(h2);
      info.appendChild(meta);
      info.appendChild(desc);
      info.appendChild(actions);

      article.appendChild(photo);
      article.appendChild(info);
      return article;
    }

    // --- Replace a card in place after status change (keeps list order) ---
    function refreshCard(article, updatedBooking) {
      const newCard = renderBookingCard(updatedBooking);
      article.replaceWith(newCard);
    }

    // --- Load bookings for current user and render grid ---
    async function loadBookings() {
      const grid = document.getElementById("grid");
      const user = (Auth && (Auth.getUser?.() || Auth.user)) || null;
      const userId = user?.id_user || user?.id;

      if (!userId) {
        clearGrid();
        showEmpty("Non riusciamo a identificare l'utente. Effettua nuovamente l'accesso.");
        return;
      }

      try {
        const res = await fetch(`${BOOKINGS_API}/user/${userId}`, { credentials: "include" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        clearGrid();

        if (!Array.isArray(data) || data.length === 0) {
          showEmpty("Non hai ancora prenotazioni.");
          return;
        }

        // Render each booking card
        for (const b of data) {
          grid.appendChild(renderBookingCard(b));
        }
      } catch (e) {
        clearGrid();
        showError("Impossibile recuperare le prenotazioni. Riprova pi√π tardi.");
      }
    }

    // --- Helpers to manage grid content / messages ---
    function clearGrid() {
      const grid = document.getElementById("grid");
      grid.innerHTML = "";
    }
    function showEmpty(message) {
      const grid = document.getElementById("grid");
      const div = document.createElement("div");
      div.className = "empty";
      div.textContent = message;
      grid.appendChild(div);
    }
    function showError(message) {
      const el = document.getElementById("error");
      el.textContent = message;
      el.style.display = "block";
      // Auto-hide after a short time to reduce friction
      setTimeout(() => { el.style.display = "none"; }, 5000);
    }

    // --- Kickoff: once DOM is ready, fetch and render bookings ---
    document.addEventListener("DOMContentLoaded", loadBookings);
  </script>
</body>
</html>